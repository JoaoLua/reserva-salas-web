<mat-toolbar color="primary" class="topbar mat-elevation-z4">
  <div class="brand">
    <mat-icon>calendar_month</mat-icon>
    <span>Reserva de Salas</span>
  </div>
  <span class="spacer"></span>
  
  <button mat-button (click)="exportCSV()" title="Exportar para Excel">
    <mat-icon>file_download</mat-icon> Exportar CSV
  </button>

  <button mat-flat-button color="warn" (click)="clearAllBookings()">
    <mat-icon>delete_sweep</mat-icon> Limpar Reservas
  </button>
</mat-toolbar>

<div class="dashboard-grid">
  <aside class="sidebar">
    <mat-card appearance="outlined" class="config-card">
      <mat-card-content>
        <div class="sidebar-header">
          <mat-icon color="primary">settings</mat-icon>
          <span class="mat-headline-6">Configurar</span>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Data da Reserva</mat-label>
          <input matInput [matDatepicker]="picker" [(ngModel)]="selectedDate" (dateChange)="loadData()">
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Buscar Sala</mat-label>
          <input matInput [(ngModel)]="searchQuery" placeholder="Ex: Auditório">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <div class="selection-box" *ngIf="selectedRoom; else noSelection">
          <span class="label text-secondary">Sala Selecionada</span>
          <mat-chip-set>
            <mat-chip highlighted color="accent">
              {{ selectedRoom.name }}
            </mat-chip>
          </mat-chip-set>
        </div>
        <ng-template #noSelection>
          <div class="selection-box empty">
            <span class="text-secondary italic">Nenhuma sala selecionada</span>
          </div>
        </ng-template>

        <div class="slots-section" *ngIf="selectedRoom">
          <h3 class="mat-subtitle-2 sidebar-title">
            <mat-icon>schedule</mat-icon> Horários Disponíveis
          </h3>
          <div class="time-grid">
            <div *ngFor="let t of TIME_SLOTS" 
                 class="time-slot" 
                 [class.occupied]="isOccupied(t)"
                 (click)="onSlotClick(t)">
              <span class="t-label">{{ t }}</span>
              <span class="t-status">{{ isOccupied(t) ? 'Ocupado' : 'Disponível' }}</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </aside>

  <main class="main-content">
    
    <div class="rooms-container">
      <mat-card *ngFor="let room of filteredRooms" 
                class="room-item mat-elevation-z1" 
                [class.selected]="selectedRoom?.id === room.id"
                (click)="selectRoom(room)">
        <mat-card-content>
          <div class="room-header">
            <div class="room-title-group">
              <div class="mat-subtitle-1 fw-bold">{{ room.name }}</div>
              <div class="mat-caption text-secondary">{{ room.type }} • {{ room.floor }}</div>
            </div>
            <mat-chip-set>
              <mat-chip color="accent" highlighted>
                <mat-icon matChipAvatar>groups</mat-icon>
                {{ room.capacity }}
              </mat-chip>
            </mat-chip-set>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-card appearance="outlined" class="table-card">
      <mat-card-header>
        <mat-card-title>Reservas do Dia</mat-card-title>
        <mat-card-subtitle>Listagem de horários ocupados para a data selecionada</mat-card-subtitle>
      </mat-card-header>
      
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" class="full-width">
          
          <ng-container matColumnDef="time">
            <th mat-header-cell *matHeaderCellDef> Hora </th>
            <td mat-cell *matCellDef="let b" class="fw-bold"> {{b.time}} </td>
          </ng-container>

          <ng-container matColumnDef="room">
            <th mat-header-cell *matHeaderCellDef> Sala </th>
            <td mat-cell *matCellDef="let b"> {{b.roomName}} </td>
          </ng-container>

          <ng-container matColumnDef="user">
            <th mat-header-cell *matHeaderCellDef> Responsável </th>
            <td mat-cell *matCellDef="let b"> {{b.reservedBy}} </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> </th>
            <td mat-cell *matCellDef="let b" class="text-right">
              <button mat-icon-button color="warn" 
                      title="Cancelar Reserva"
                      (click)="cancelBooking(b.time, b.roomName)">
                <mat-icon>cancel</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>
          
          <tr class="mat-row no-data-row" *matNoDataRow>
            <td class="mat-cell" colspan="4">Nenhuma reserva encontrada.</td>
          </tr>
        </table>
      </div>
    </mat-card>
  </main>
</div>